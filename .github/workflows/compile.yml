---
name: 'Compile the tools'

on:
  push:         { branches: [ 'main' ] }
  pull_request: { branches: [ 'main' ] }

jobs:
  csharp:
    runs-on: 'windows-latest'
    strategy:
      matrix: { project: [ 'Seatbelt' ] }
    steps:
      - name: 'Checkout code'
        uses: 'actions/checkout@v4'
        with:
          fetch-depth: 1
          submodules: 'recursive'

      - name: 'Setup MSBuild'
        uses: 'microsoft/setup-msbuild@v2'

      - name: 'Build the solution'
        run: 'msbuild /p:Configuration=Release'
        working-directory: 'windows/${{ matrix.project }}'

      - name: 'Archive the artifacts'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'windows/${{ matrix.project }}'
          path: 'windows/${{ matrix.project }}/${{ matrix.project }}/bin/Release/${{ matrix.project }}.exe'
          if-no-files-found: 'error'

  powershell:
    runs-on: 'ubuntu-latest'
    strategy:
      matrix: { project: [ 'PowerSharpPack' ] }
    steps:
      - name: 'Checkout code'
        uses: 'actions/checkout@v4'
        with:
          fetch-depth: 1
          submodules: 'recursive'

      - name: 'Copy all the PWSH scripts'
        run: |
          mkdir -p /tmp/${{ matrix.project }}
          cp -r ./**/*.ps1 /tmp/${{ matrix.project }}/
        working-directory: 'windows/${{ matrix.project }}'

      - name: 'Archive the artifacts'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'windows/${{ matrix.project }}'
          path: '/tmp/${{ matrix.project }}/'
          if-no-files-found: 'error'

  bundle:
    runs-on: 'ubuntu-latest'
    needs: [ 'csharp', 'powershell' ]
    steps:
      - name: 'Download csharp artifacts'
        uses: 'actions/download-artifact@v4'
        with:
          path: '/tmp/bundle/'
          pattern: '*'
          merge-multiple: true

      - name: 'Remove the temporary artifacts'
        uses: 'geekyeggo/delete-artifact@v5'
        with:
          name: '*'

      - name: 'Upload the final artifact'
        uses: 'actions/upload-artifact@v4'
        with:
          if-no-files-found: 'error'
          name: 'hackpack'
          path: '/tmp/bundle/'
          compression-level: 9
...
